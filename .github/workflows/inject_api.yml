name: Inject API (Safe)

on:
  workflow_dispatch:
    inputs:
      write_env_file:
        description: "Whether to write a local env file (.runtime/api.env) for subsequent steps (NOT committed)."
        required: false
        default: "true"
      env_file_path:
        description: "Path to write env file (relative)."
        required: false
        default: ".runtime/api.env"
      upload_artifact:
        description: "Upload env file as artifact for downstream jobs."
        required: false
        default: "true"
      artifact_name:
        description: "Artifact name if upload_artifact=true"
        required: false
        default: "api-env"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/inject_api.yml"
      - "requirements.txt"
      - "server.py"
      - "scripts/**"
      - "src/**"

permissions:
  contents: read

concurrency:
  group: inject-api-${{ github.ref }}
  cancel-in-progress: true

jobs:
  inject:
    name: Inject API Secrets into Runner Env
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets exist
        shell: bash
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${API_TOKEN:-}" ]]; then
            echo "ERROR: Missing required secret: API_TOKEN"
            echo "Add it in repo Settings -> Secrets and variables -> Actions -> New repository secret"
            exit 1
          fi

      - name: Mask secrets (prevent accidental log exposure)
        shell: bash
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
        run: |
          set -euo pipefail
          echo "::add-mask::${API_TOKEN}"
          if [[ -n "${API_BASE_URL:-}" ]]; then
            echo "::add-mask::${API_BASE_URL}"
          fi

      - name: Export secrets to job environment (safe)
        shell: bash
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
        run: |
          set -euo pipefail
          {
            echo "API_TOKEN=${API_TOKEN}"
            if [[ -n "${API_BASE_URL:-}" ]]; then
              echo "API_BASE_URL=${API_BASE_URL}"
            fi
          } >> "${GITHUB_ENV}"

      - name: Setup Python (optional - if you run scripts after injection)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies (optional)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f "requirements.txt" ]]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found; skipping."
          fi

      - name: Write env file for subsequent steps (NOT committed)
        if: ${{ inputs.write_env_file != 'false' }}
        shell: bash
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          ENV_FILE_PATH: ${{ inputs.env_file_path }}
        run: |
          set -euo pipefail
          umask 077

          # Ensure parent dir exists
          mkdir -p "$(dirname "${ENV_FILE_PATH}")"

          # Write without echoing secret to logs
          : > "${ENV_FILE_PATH}"
          printf "API_TOKEN=%s\n" "${API_TOKEN}" >> "${ENV_FILE_PATH}"

          if [[ -n "${API_BASE_URL:-}" ]]; then
            printf "API_BASE_URL=%s\n" "${API_BASE_URL}" >> "${ENV_FILE_PATH}"
          fi

          # Tight permissions (600)
          chmod 600 "${ENV_FILE_PATH}"

      - name: Upload env file as artifact (optional)
        if: ${{ inputs.upload_artifact != 'false' && inputs.write_env_file != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.env_file_path }}
          if-no-files-found: error
          retention-days: 1

      - name: Example - run a script that uses the injected API env (optional)
        shell: bash
        env:
          # Available from GITHUB_ENV now
          API_TOKEN: ${{ env.API_TOKEN }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: |
          set -euo pipefail
          # Do NOT print $API_TOKEN.
          # Example placeholders (only run if you have such a script):
          if [[ -f "scripts/inject_api.py" ]]; then
            python scripts/inject_api.py
          else
            echo "No scripts/inject_api.py found; injection complete."
          fi
